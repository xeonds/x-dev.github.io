---
title: 磁带机入坑小记
date: 2024-07-08 11:39:09
author: xeonds
toc: true
excerpt: 世上只有两种人：不备份数据的人和丢失过数据的人
tags:
    - 存储
    - 备份
---

>世上只有两种人：不备份数据的人和丢失过数据的人

坑是去年入的，机是今年才用的，数据是才备份好的，磁带是热乎的。

## 机器
这个磁带机是我怂恿Ray一块合买的一个戴尔的LTO4磁带机。机器成色看着可以，这东西最大的问题是，这个价格只能买到走SAS连接的版本。所以在这之外还整了个HBA板卡用来把这东西接入主机的PCIE连接。

此外为了实现一些神奇的操作，我俩还整了个PCIE延长插槽，最后~~转换器插转换器插转换器~~成功给这玩意插到Ray的老ThinkPad上的Express插槽上了（Think.jpg

## 安装
一个电源，一个sas接口，都插上就完事了。就是得注意启动顺序，磁带机得在电脑之前上电启动。

Windows底下应该能在设备管理器底下找到磁带机的影子，Linux底下看看`/dev`底下有没有`st0, nst0`之类的字符设备就行，有就是连上了。

## 使用
只要你不是命令行恐惧症，我一律推荐你直接上Linux用GNU tar作为数据备份工具。Windows上那依托数据备份软件又贵又不好用，不如直接tar。

具体来说，插上磁带机之后，开机启动，系统里的`/dev`下应该会出现几个新的字符设备，一般有这么几个：`st0, nst0`之类的。这两个表示一个设备的两个模式，前者在操作完成后会自动倒带，后者则不会自动倒带。

Linux的文件模型将所有设备视为文件进行管理，对于磁带机同理。我们可以像使用其他设备一样使用磁带机，甚至可以直接用重定向符把输出流重定向到磁带机，或者直接用`dd`把数据写入磁带机设备。

另外由于数据IO作为系统调用，它一旦因为一些奇怪的原因失败有概率会导致系统内核因为死锁挂掉，症状就是其他的文件IO操作都会失败。这种时候只能重启了。

Win上我就不列出了，用过一个L开头的备份软件，又要收费又不好用。Linux上常用的有tar,dd,cpio等。这里只介绍tar和一个磁带机管理工具。另外*tar适用单磁带备份*，多磁带备份可以自行了解cpio。

### tar使用笔记
|操作|指令|
|:-|:-|
|全盘覆盖从头写入|`tar cvf /dev/st0 files/dirs`|
|附加模式写入磁带后部|`tar rvf /dev/st0 files/dirs`|
|获取磁带文件列表|`tar tvf /dev/st0 > filelist.txt`|
|从磁带恢复文件列表到当前目录|`tar xvf /dev/st0 [files/dirs]`|

这里没列全，tar还有很多用法，比如增量备份，文件恢复

注意，磁带是线性文件系统，在LTFS出现之前的版本（比如LTO4），上面的操作都是很耗时的。

### mt-st使用笔记
`mt-st`就是*Manage Tape*的缩写。它是用来管理磁带机的工具。

|操作|指令|
|:-|:-|
|`mt-st -f /dev/st0 status`|获取设备状态|
|`mt-st -f /dev/st0 rewind`|倒带|
|`mt-st -f /dev/st0 eject`|弹出磁带|
|`mt-st -f /dev/st0 erase`|**慎用，对磁带有损伤且一般无必要** 擦除磁带所有数据|

### 其他玩法
刚说过了，磁带机作为一个字符设备，使用方式和其他设备一样，都是把输出数据流重定向到它在`/dev`下对应的字符设备。那玩法就多了。

首先，数据流可以从远端传过来：
- 所以磁带机完全可以供多人**远程使用**，只要本地留个人插拔磁带就彳亍。比如通过ssh将自己的数据传入磁带机，实现远程数据备份。
- 局域网（比如校园局域网)底下这么玩很爽

另外不光能远程，这个数据流还可以从别的进程传过来。比如可以从你的OBS推流里传过来，可以从你的其他设备传过来（比如摄像头之类的数据采集设备），可以从你的文件下载进程里传过来，还可以从任何数据处理进程里传过来。

反正最后都是花式数据备份嘛。实在闲得没事了还可以写个自助备份系统给别人用用。

## 结
每次掏出来磁带机就有人说这东西随机读写性能不行，傻逼才买。先不说某些人的教养问题，单说抛开需求和使用场景来看设备那不纯耍流氓。

一个纯用来冷备份的设备，作为长期数据储存的设备，真的有人会需要这玩意的随机读写能力？一般使用不都是数据丢失了，插上磁带开始全盘/指定文件列表开始数据恢复嘛。当然你要想的是在这里边~~下原神~~打游戏那当我没说。

而且随机读写性能不等于读写性能，这玩意读写是能跑到**100+MiBps，也就是800+Mbps**的，一般手机下载文件/普通U盘文件传输连续读写都跑不到这速度，而且**LTO4的磁带15r/盘，容量800GiB（不开压缩）~1600GiB（开压缩）**，LTO4磁带机价格也下来了，拿来冷备份的成本和**可靠性**都远比机械/固态优秀。

不过这玩意小众还是有原因的，最大的原因是这玩意一般不面向普通个人消费者，而是大型数据中心。其次是这玩意价格普遍很贵，特别是磁带机。只有那些相对落后几代的产品才有对比普通存储介质备份方案很明显的性价比优势。

嘛，本来想说下素质问题，想了下没必要，都那样了，还是顺从吧：”啊对对对“。

## References

- [GNU tar 1.35: 9.6 Using Multiple Tapes](https://www.gnu.org/software/tar/manual/html_section/Using-Multiple-Tapes.html)
- [GNU tar 1.35: 9 Tapes and Other Archive Media](https://www.gnu.org/software/tar/manual/html_chapter/Media.html)
- [Linux 磁带机备份完全攻略 - 李济宏（Amadeus） - 博客园](https://www.cnblogs.com/amadeuslee/p/3799484.html)
- [Arch Linux下使用HPE LTO5磁带机（含LTFS）记录 - 知乎](https://zhuanlan.zhihu.com/p/659337882)
- [Linux、UNIX下磁带机的管理和使用 （作者：张亚宁） - ITPUB博客](https://blog.itpub.net/223653/viewspace-1301748/)
- [{LTO磁带寿命预估}{怎样计算LTO磁带寿命}{如何让LTO磁带寿命更长}](http://www.01-datastorage.com/c/keep.html)

